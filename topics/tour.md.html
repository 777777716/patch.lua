<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Patch.lua</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>patch.lua</h1>




<h2>Topics</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><strong>Tour</strong></li>
</ul>
<h2>Modules</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../index.html">patch</a></li>
</ul>

</div>

<div id="content">


<h2>Tour</h2>

<pre>
patch = <span class="global">require</span> <span class="string">'patch'</span>
</pre>

<p>The core verb of patch is <a href="../index.html#apply">patch.apply</a>. As the name suggests, it
applies a patch to an existing value, and spits out the result:</p>

<pre>
<span class="comment">-- Replace the input (1) with the new value (2)
</span>value = <span class="number">1</span>
value, undo = patch.apply(value, <span class="number">2</span>) <span class="comment">-- replace value with 2
</span>
<span class="global">print</span>(value) <span class="comment">-- 2
</span>
</pre>

<p>Patches are normal Lua values. Here we used the number 2, but we can
update a value to whatever we want.</p>

<pre>
value, undo2 = patch.apply(value, <span class="string">"magic"</span>)    <span class="comment">--       2 -&gt; "magic"
</span>value, undo3 = patch.apply(value, {<span class="string">"carpet"</span>}) <span class="comment">-- "magic" -&gt; {"carpet"}
</span>
</pre>

<p>Every time you call apply, in addition to the the result value, it will
also spit out an "undo" patch. This will be an inverse of the input
patch: if you give the current value and the undo back to
apply it will give you the original value.</p>

<pre>
value, _ = patch.apply(value, undo3) <span class="comment">-- {"carpet"} -&gt; "magic"
</span>value, _ = patch.apply(value, undo2) <span class="comment">--    "magic" -&gt; 2
</span>value, _ = patch.apply(value, undo)  <span class="comment">--          2 -&gt; 1
</span>
</pre>

<p>Patch supports more complex operations than simple replacement, though.
When the input and the patch are both tables, then each value in the
patch table is recursively applied to the input table, like so:</p>

<pre>
t = { a = <span class="number">1</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>}
t2, _ = patch.apply(t,  {[<span class="number">2</span>] = <span class="number">2</span>})           <span class="comment">-- t2[2]    = 2
</span>t3, _ = patch.apply(t2, {a = {age = <span class="string">"old"</span>}}) <span class="comment">-- t3.a     = {age = "old"}
</span>t4, _ = patch.apply(t3, {a = {age = <span class="string">"new"</span>}}) <span class="comment">-- t4.a.age = "new"
</span>
</pre>

<p>When working with complex types like this, apply makes the
guarantee that it won't modify the input table:</p>

<pre>
<span class="global">print</span>(t == t4)   <span class="comment">-- false
</span><span class="global">print</span>(t.a)       <span class="comment">-- b
</span><span class="global">print</span>(t2.a)      <span class="comment">-- 2
</span><span class="global">print</span>(t3[<span class="number">2</span>].age) <span class="comment">-- old
</span>
</pre>

<p>But if you'd rather reuse a single instance of a datastructure, you can
use <a href="../index.html#apply_inplace">patch.apply_inplace</a> instead.</p>

<pre>
t5, _ = patch.apply_inplace(t4, {a = <span class="number">3</span>}) <span class="comment">-- t4.a = 3
</span>
<span class="global">print</span>(t4 == t5)     <span class="comment">-- true
</span><span class="global">print</span>(t4.a == t5.a) <span class="comment">-- true
</span>
</pre>

<p>These two primitive behaviors, replacing and merging, work for many of
changes you might want to make to a table. However, this can't represent
everything. For example, if you want to set a field in a table to nil,
this won't work:</p>

<pre>
patch.apply({field = <span class="string">"set"</span>}, {field = <span class="keyword">nil</span>}) <span class="comment">-- {field = "set"}, nil
</span>
</pre>

<p>That's because in Lua, <code>nil</code> is the same as <code>undefined</code>. instead of
passing in a field set to <code>nil</code>, we've passed in nothing at all!</p>

<p>To fix this we use <a href="../index.html#updaters">Updaters</a>. An updater is a simple marker that suggests
that patch should do something special when applying it. For this
specific example, we can use the <a href="../index.html#Nil">patch.Nil</a> updater, which will always
replace the input with nil:</p>

<pre>
patch.apply({field = <span class="string">"set"</span>}, {field = patch.Nil} <span class="comment">-- {}, {field = "set"}
</span>
</pre>



</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.3</a></i>
<i style="float:right;">Last updated 2016-06-18 17:08:06 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
